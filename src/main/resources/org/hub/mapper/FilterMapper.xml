<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.hub.mapper.FilterMapper">

<!--  검색 기능 -->
	<sql id="criteria">
		<trim prefix="(" suffix=") AND " prefixOverrides="OR">
			<foreach item='type' collection="typeArr">
				<trim prefix="OR">
					<choose>
						<when test="type == 'T'.toString()">
							title like '%'||#{keyword}||'%'
						</when>
						<when test="type == 'C'.toString()">
							content like '%'||#{keyword}||'%'
						</when>
						<when test="type == 'W'.toString()">
							writer like '%'||#{keyword}||'%'
						</when>
					</choose>
				</trim>
			</foreach>
		</trim>
	</sql>

	<select id="getListWithFilter" parameterType="org.hub.domain.BoardVO">
	   <![CDATA[
		SELECT bno, deadline, uidkey ,title,content, uname, fnames, snames, cnt, replycnt, profileImage
		FROM (
		SELECT /*+INDEX_DESC(board_tbl pk_board) */
		rownum rn, b.bno, b.uidkey, b.deadline, b.title, b.content, u.unickname AS uname, a.uploadPath  AS profileImage,
		   (
		    SELECT LISTAGG(f.fname, ',') WITHIN GROUP (ORDER BY f.fname) AS combined_fname 
		    FROM boardfield_tbl bf 
		    JOIN field_tbl f ON bf.fno = f.fno
		    WHERE bf.bno = b.bno
		  	) AS fnames,
		   (
		    SELECT LISTAGG(s.sname, ',') WITHIN GROUP (ORDER BY s.sname) AS combined_sname
		    FROM boardstack_tbl bs
		    JOIN stack_tbl s ON bs.sno = s.sno 
		    WHERE bs.bno = b.bno
		   ) AS snames, cnt, replycnt  
		FROM (
			SELECT bno, deadline, title, content,uidkey, cnt, replycnt
			FROM board_tbl
			ORDER BY bno desc
		) b
		JOIN user_tbl u
		ON b.uidkey = u.uidkey
		JOIN attach_tbl a
		ON u.uidkey = a.uidkey
		WHERE
		]]>

	<include refid="criteria"></include>

	<![CDATA[
	 rownum <= #{pageNum} * #{amount} 
	) 
	WHERE rn > (#{pageNum} - 1) * #{amount} AND snames LIKE '%#{filter}%'
	]]>
	</select>

</mapper>